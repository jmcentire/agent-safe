<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent-Safe â€” The SQLite of Agent Authorization</title>
<meta name="description" content="Embed authorization in the token. 150 lines. Zero deps. Microseconds. Portable capability tokens for AI agents.">
<style>
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --border: #30363d;
  --text: #e6edf3;
  --muted: #8b949e;
  --accent: #58a6ff;
  --green: #3fb950;
  --red: #f85149;
  --yellow: #d29922;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  --mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: var(--font); line-height: 1.6; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }
code, pre { font-family: var(--mono); font-size: 0.9em; }
pre { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 16px; overflow-x: auto; }
.container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

/* Hero */
.hero { text-align: center; padding: 80px 0 48px; }
.hero h1 { font-size: 2.6em; margin-bottom: 8px; letter-spacing: -0.02em; }
.hero h1 span { color: var(--accent); }
.hero .tagline { font-size: 1.3em; color: var(--muted); max-width: 640px; margin: 0 auto 24px; }
.hero .perf { font-family: var(--mono); font-size: 1.05em; color: var(--green); background: #0d2818; border: 1px solid #238636; border-radius: 6px; display: inline-block; padding: 8px 20px; }

/* Section */
section { padding: 48px 0; border-top: 1px solid var(--border); }
section h2 { font-size: 1.6em; margin-bottom: 16px; }

/* Problem */
.problem p { color: var(--muted); font-size: 1.05em; max-width: 720px; margin-bottom: 16px; }
.problem strong { color: var(--text); }
.problem-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 20px; }
.problem-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
.problem-card h4 { color: var(--yellow); margin-bottom: 6px; font-size: 0.95em; }
.problem-card p { color: var(--muted); font-size: 0.88em; }
@media (max-width: 700px) { .problem-grid { grid-template-columns: 1fr; } }

/* Comparison */
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); }
th { color: var(--muted); font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.05em; }
td { font-size: 0.88em; }
td:first-child { font-weight: 600; white-space: nowrap; }
.yes { color: var(--green); }
.no { color: var(--red); }
.partial { color: var(--yellow); }

/* Architecture */
.arch { display: flex; align-items: center; justify-content: center; gap: 14px; margin: 28px 0; flex-wrap: wrap; }
.arch-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 22px; text-align: center; min-width: 110px; }
.arch-box .label { font-size: 0.75em; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
.arch-box .name { font-size: 1em; font-weight: 600; }
.arch-arrow { font-size: 1.4em; color: var(--muted); }

/* Perf */
.perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
.perf-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; }
.perf-card .number { font-size: 2em; font-weight: 700; color: var(--green); font-family: var(--mono); }
.perf-card .label { font-size: 0.85em; color: var(--muted); margin-top: 4px; }
@media (max-width: 700px) { .perf-grid { grid-template-columns: 1fr; } }

/* Demo */
.demo { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-top: 16px; }
.demo-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.demo label { display: block; font-size: 0.85em; color: var(--muted); margin-bottom: 4px; }
.demo textarea { width: 100%; height: 160px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 8px; font-family: var(--mono); font-size: 0.85em; resize: vertical; }
.demo button { margin-top: 12px; padding: 8px 24px; background: var(--accent); color: #fff; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
.demo button:hover { opacity: 0.9; }
#demo-result { margin-top: 12px; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 1.1em; display: none; }
#demo-result.allow { display: block; background: #0d2818; color: var(--green); border: 1px solid #238636; }
#demo-result.deny { display: block; background: #2d1215; color: var(--red); border: 1px solid #da3633; }
#demo-result.error { display: block; background: #2d1215; color: var(--red); border: 1px solid #da3633; }
@media (max-width: 700px) { .demo-row { grid-template-columns: 1fr; } }

/* Install */
.install-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
.install-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px 16px; position: relative; }
.install-card .lang { font-size: 0.8em; color: var(--accent); margin-bottom: 4px; }
.install-card code { display: block; font-size: 0.85em; white-space: nowrap; overflow-x: auto; }
.copy-btn { position: absolute; top: 8px; right: 8px; background: var(--border); color: var(--text); border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.75em; cursor: pointer; }
.copy-btn:hover { background: var(--muted); }
@media (max-width: 700px) { .install-grid { grid-template-columns: 1fr; } }

/* SQLite callout */
.callout { background: var(--surface); border-left: 3px solid var(--accent); border-radius: 0 6px 6px 0; padding: 16px 20px; margin: 24px 0; }
.callout p { color: var(--muted); font-size: 0.95em; }
.callout strong { color: var(--text); }

/* Footer */
footer { padding: 32px 0; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.9em; }
footer a { margin: 0 12px; }
</style>
</head>
<body>

<!-- Hero -->
<div class="container">
<div class="hero">
  <h1><span>Agent-Safe</span></h1>
  <p class="tagline">Embed authorization in the token. 150 lines. Zero deps. Microseconds.</p>
  <div class="perf">Parse + eval: ~15 &mu;s &nbsp;&middot;&nbsp; Eval only: ~2 &mu;s</div>
</div>
</div>

<!-- Problem -->
<div class="container">
<section class="problem">
  <h2>The Problem with Policy Servers</h2>
  <p>Every authorization decision an AI agent makes currently requires a <strong>round-trip to a policy server</strong>. At agent scale &mdash; thousands of micro-decisions per second across thousands of agents &mdash; that's not a reliability problem. It's a <strong>throughput and latency tax on every operation</strong>.</p>
  <p>SPL moves the policy into the token. The service that receives the request verifies it locally. The policy server only matters when <strong>minting</strong> the token, not when <strong>verifying</strong> it.</p>
  <div class="problem-grid">
    <div class="problem-card">
      <h4>Latency Tax</h4>
      <p>OPA/Cedar add 1&ndash;5 ms per decision (network + evaluation). SPL evaluates in ~2 &mu;s. That's 500&ndash;2,500x faster.</p>
    </div>
    <div class="problem-card">
      <h4>Throughput Bottleneck</h4>
      <p>1,000 agents &times; 100 decisions/min = 100K requests/min to your policy server. With SPL, it's zero.</p>
    </div>
    <div class="problem-card">
      <h4>Coarse-Grained Scopes</h4>
      <p>OAuth tokens grant broad access. SPL lets you say "only purchases under $50 for gift cards to family members, max 1 per day."</p>
    </div>
  </div>
</section>
</div>

<!-- Architecture -->
<div class="container">
<section>
  <h2>Architecture</h2>
  <div class="arch">
    <div class="arch-box">
      <div class="label">Grantor</div>
      <div class="name">Signs token</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box">
      <div class="label">Agent</div>
      <div class="name">Carries token</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box">
      <div class="label">Service</div>
      <div class="name">verify(token)</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box" style="border-color: var(--green);">
      <div class="label">Result</div>
      <div class="name" style="color: var(--green);">ALLOW / DENY</div>
    </div>
  </div>
  <p style="color: var(--muted); text-align: center; font-size: 0.9em;">Token = signed SPL policy + Merkle root + hash-chain commitment + DPoP binding. One function call. No server.</p>
  <div class="callout">
    <p><strong>The SQLite of agent authorization.</strong> You embed it. It's 150 lines. No server to deploy, no sidecar to manage, no protobuf to compile. When you outgrow it, you'll know.</p>
  </div>
</section>
</div>

<!-- Performance -->
<div class="container">
<section>
  <h2>Performance</h2>
  <p style="color: var(--muted); margin-bottom: 8px;">Benchmarked on Apple M1 Max. Policy: <code>family_gifts.spl</code> (10 conjuncts including crypto predicates).</p>
  <div class="perf-grid">
    <div class="perf-card">
      <div class="number">~2 &mu;s</div>
      <div class="label">Eval only (Go &amp; TypeScript)</div>
    </div>
    <div class="perf-card">
      <div class="number">~15 &mu;s</div>
      <div class="label">Parse + Eval (Go)</div>
    </div>
    <div class="perf-card">
      <div class="number">0</div>
      <div class="label">Network round-trips</div>
    </div>
    <div class="perf-card">
      <div class="number">0</div>
      <div class="label">Runtime dependencies (TS, Go, Java, C#)</div>
    </div>
  </div>
</section>
</div>

<!-- Comparison -->
<div class="container">
<section>
  <h2>Honest Comparison</h2>
  <table>
    <thead><tr><th>System</th><th>Policy in Token</th><th>Language</th><th>Local Verify</th><th>Offline Budgets</th><th>Zero Deps</th></tr></thead>
    <tbody>
      <tr><td>SPL</td><td class="yes">Yes</td><td class="yes">S-expr (~150 LOC)</td><td class="yes">Yes</td><td class="yes">Yes</td><td class="yes">Yes</td></tr>
      <tr><td>Biscuit</td><td class="yes">Yes</td><td class="partial">Datalog</td><td class="yes">Yes</td><td class="no">No</td><td class="no">Protobuf</td></tr>
      <tr><td>Macaroons</td><td class="partial">Caveats only</td><td>N/A</td><td class="partial">Partial</td><td class="no">No</td><td class="partial">HMAC lib</td></tr>
      <tr><td>Cedar</td><td class="no">No</td><td class="yes">Full policy</td><td class="no">Server-side</td><td class="no">No</td><td class="no">Engine</td></tr>
      <tr><td>OPA/Rego</td><td class="no">No</td><td class="no">Rego (Turing-complete)</td><td class="no">Server-side</td><td class="no">No</td><td class="no">OPA server</td></tr>
    </tbody>
  </table>
  <div class="callout" style="margin-top: 20px;">
    <p><strong>Where Biscuit wins:</strong> third-party blocks, revocation IDs, token sealing (SPL now has this too), and production maturity. <strong>Where SPL wins:</strong> 150-line evaluator, zero dependencies, hash-chain offline budgets, and no protobuf in the critical path. Choose Biscuit when you need multi-org delegation. Choose SPL when you need the simplest thing that works.</p>
  </div>
</section>
</div>

<!-- Interactive Demo -->
<div class="container">
<section>
  <h2>Try It</h2>
  <p style="color: var(--muted); margin-bottom: 12px;">Edit the policy or request and click Evaluate. This runs the full SPL evaluator in your browser &mdash; the same algorithm as all six server-side SDKs.</p>
  <div class="demo">
    <div class="demo-row">
      <div>
        <label>Policy (SPL)</label>
        <textarea id="demo-policy">(and
  (= (get req "action") "payments.create")
  (<= (get req "amount") 50)
  (member (get req "recipient") allowed_recipients)
)</textarea>
      </div>
      <div>
        <label>Request (JSON)</label>
        <textarea id="demo-request">{
  "action": "payments.create",
  "amount": 30,
  "recipient": "niece@example.com"
}</textarea>
      </div>
    </div>
    <button onclick="runDemo()">Evaluate</button>
    <div id="demo-result"></div>
  </div>
</section>
</div>

<!-- Get Started -->
<div class="container">
<section>
  <h2>Get Started</h2>
  <div class="install-grid">
    <div class="install-card">
      <div class="lang">TypeScript / Node.js</div>
      <code>npm install agent-safe-spl</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Go</div>
      <code>go get github.com/jmcentire/agent-safe/sdk/go</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Python</div>
      <code>pip install agent-safe-spl</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Rust</div>
      <code>cargo add agent-safe-spl</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Java (JDK 21+, from source)</div>
      <code>cd sdk/java && mvn install</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">C# (.NET 10+, from source)</div>
      <code>cd sdk/csharp && dotnet build</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
  </div>
  <p style="color: var(--muted); font-size: 0.85em; margin-top: 16px; text-align: center;">234 tests across 6 SDKs. Shared crypto test vectors ensure cross-language compatibility.</p>
</section>
</div>

<!-- Footer -->
<div class="container">
<footer>
  <a href="https://github.com/jmcentire/agent-safe">GitHub</a>
  <a href="https://github.com/jmcentire/agent-safe/blob/main/SPEC.md">Spec</a>
  <a href="https://github.com/jmcentire/agent-safe/blob/main/HOWTO.md">HOWTO</a>
  <p style="margin-top: 12px;">MIT License &middot; Jeremy McEntire</p>
</footer>
</div>

<script>
// Minimal SPL evaluator (in-browser, no deps)
function tokenize(src) {
  const toks = []; let buf = '', inStr = false;
  for (let j = 0; j < src.length; j++) {
    const ch = src[j];
    if (inStr) { buf += ch; if (ch === '"' && src[j-1] !== '\\') { inStr = false; toks.push(buf); buf = ''; } continue; }
    if (ch === '"') { if (buf.trim()) toks.push(...buf.trim().split(/\s+/)); buf = '"'; inStr = true; continue; }
    if (ch === '(' || ch === ')') { if (buf.trim()) toks.push(...buf.trim().split(/\s+/)); toks.push(ch); buf = ''; continue; }
    buf += ch;
  }
  if (buf.trim()) toks.push(...buf.trim().split(/\s+/));
  return toks;
}
function parseSExpr(src) {
  const tokens = tokenize(src); let i = 0;
  function atom(t) { if (t==='#t') return true; if (t==='#f') return false; if (/^-?\d+(\.\d+)?$/.test(t)) return Number(t); if (t.startsWith('"')&&t.endsWith('"')) return JSON.parse(t); return t; }
  function parse() {
    if (i >= tokens.length) throw new Error('unexpected EOF');
    const t = tokens[i++];
    if (t === '(') { const a = []; while (tokens[i] !== ')') { if (i >= tokens.length) throw new Error('unterminated ('); a.push(parse()); } i++; return a; }
    if (t === ')') throw new Error('unexpected )');
    return atom(t);
  }
  return parse();
}
function evalS(n, ctx) {
  ctx._gas = (ctx._gas ?? 10000) - 1;
  if (ctx._gas < 0) throw new Error('gas budget exceeded');
  if (!Array.isArray(n)) {
    if (typeof n === 'string') {
      if (n === 'req') return ctx.req;
      if (ctx.vars && n in ctx.vars) return ctx.vars[n];
    }
    return n;
  }
  if (n.length === 0) return null;
  const [op, ...args] = n;
  switch (op) {
    case 'and': return args.every(a => !!evalS(a, ctx));
    case 'or': return args.some(a => !!evalS(a, ctx));
    case 'not': return !evalS(args[0], ctx);
    case '=': return evalS(args[0], ctx) === evalS(args[1], ctx);
    case '<=': return evalS(args[0], ctx) <= evalS(args[1], ctx);
    case '<': return evalS(args[0], ctx) < evalS(args[1], ctx);
    case '>=': return evalS(args[0], ctx) >= evalS(args[1], ctx);
    case '>': return evalS(args[0], ctx) > evalS(args[1], ctx);
    case 'member': case 'in': { const v = evalS(args[0], ctx), l = evalS(args[1], ctx); return Array.isArray(l) && l.includes(v); }
    case 'subset?': { const a = evalS(args[0], ctx), b = evalS(args[1], ctx); return Array.isArray(a) && Array.isArray(b) && a.every(x => b.includes(x)); }
    case 'before': return evalS(args[0], ctx) < evalS(args[1], ctx);
    case 'get': { const o = evalS(args[0], ctx), k = evalS(args[1], ctx); return o?.[k]; }
    case 'tuple': return args.map(a => evalS(a, ctx));
    case 'per-day-count': return 0;
    case 'dpop_ok?': case 'merkle_ok?': case 'vrf_ok?': case 'thresh_ok?': return true;
    default: throw new Error('Unknown op: ' + op);
  }
}

function runDemo() {
  const el = document.getElementById('demo-result');
  try {
    const policy = document.getElementById('demo-policy').value.trim();
    const request = JSON.parse(document.getElementById('demo-request').value);
    const ast = parseSExpr(policy);
    const ctx = {
      req: request,
      vars: { allowed_recipients: ['niece@example.com', 'mom@example.com'], now: new Date().toISOString() }
    };
    const result = !!evalS(ast, ctx);
    el.textContent = result ? 'ALLOW' : 'DENY';
    el.className = result ? 'allow' : 'deny';
  } catch (e) {
    el.textContent = 'Error: ' + e.message;
    el.className = 'error';
  }
}

function copyCmd(btn) {
  const code = btn.parentElement.querySelector('code').textContent;
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}
</script>
</body>
</html>
