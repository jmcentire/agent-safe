<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent-Safe — Portable Capability Tokens for AI Agents</title>
<style>
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --border: #30363d;
  --text: #e6edf3;
  --muted: #8b949e;
  --accent: #58a6ff;
  --green: #3fb950;
  --red: #f85149;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
  --mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: var(--font); line-height: 1.6; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }
code, pre { font-family: var(--mono); font-size: 0.9em; }
pre { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 16px; overflow-x: auto; }
.container { max-width: 900px; margin: 0 auto; padding: 0 24px; }

/* Hero */
.hero { text-align: center; padding: 80px 0 60px; }
.hero h1 { font-size: 2.5em; margin-bottom: 12px; }
.hero h1 span { color: var(--accent); }
.hero p { font-size: 1.2em; color: var(--muted); max-width: 600px; margin: 0 auto; }
.hero .badges { margin-top: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
.badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; border: 1px solid var(--border); color: var(--muted); }

/* Section */
section { padding: 48px 0; border-top: 1px solid var(--border); }
section h2 { font-size: 1.6em; margin-bottom: 16px; }
section h3 { font-size: 1.1em; margin: 16px 0 8px; color: var(--muted); }

/* Problem */
.problem-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 16px; }
.problem-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
.problem-card h4 { color: var(--red); margin-bottom: 8px; }
.problem-card p { color: var(--muted); font-size: 0.9em; }
@media (max-width: 700px) { .problem-grid { grid-template-columns: 1fr; } }

/* Demo */
.demo { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-top: 16px; }
.demo-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.demo label { display: block; font-size: 0.85em; color: var(--muted); margin-bottom: 4px; }
.demo textarea { width: 100%; height: 160px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 8px; font-family: var(--mono); font-size: 0.85em; resize: vertical; }
.demo button { margin-top: 12px; padding: 8px 24px; background: var(--accent); color: #fff; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
.demo button:hover { opacity: 0.9; }
#demo-result { margin-top: 12px; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 1.1em; display: none; }
#demo-result.allow { display: block; background: #0d2818; color: var(--green); border: 1px solid #238636; }
#demo-result.deny { display: block; background: #2d1215; color: var(--red); border: 1px solid #da3633; }
#demo-result.error { display: block; background: #2d1215; color: var(--red); border: 1px solid #da3633; }
@media (max-width: 700px) { .demo-row { grid-template-columns: 1fr; } }

/* Architecture */
.arch { display: flex; align-items: center; justify-content: center; gap: 16px; margin: 24px 0; flex-wrap: wrap; }
.arch-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px 24px; text-align: center; min-width: 120px; }
.arch-box .label { font-size: 0.8em; color: var(--muted); }
.arch-box .name { font-size: 1.1em; font-weight: bold; }
.arch-arrow { font-size: 1.5em; color: var(--muted); }

/* Table */
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); }
th { color: var(--muted); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.05em; }
td { font-size: 0.9em; }

/* Install */
.install-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
.install-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px 16px; position: relative; }
.install-card .lang { font-size: 0.8em; color: var(--accent); margin-bottom: 4px; }
.install-card code { display: block; font-size: 0.85em; white-space: nowrap; overflow-x: auto; }
.copy-btn { position: absolute; top: 8px; right: 8px; background: var(--border); color: var(--text); border: none; border-radius: 4px; padding: 2px 8px; font-size: 0.75em; cursor: pointer; }
.copy-btn:hover { background: var(--muted); }
@media (max-width: 700px) { .install-grid { grid-template-columns: 1fr; } }

/* Footer */
footer { padding: 32px 0; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.9em; }
footer a { margin: 0 12px; }
</style>
</head>
<body>

<!-- Hero -->
<div class="container">
<div class="hero">
  <h1><span>Agent-Safe</span></h1>
  <p>Portable capability tokens for AI agents. One function call, microsecond evaluation, offline-verifiable.</p>
  <div class="badges">
    <span class="badge">Total language</span>
    <span class="badge">Deterministic</span>
    <span class="badge">6 SDKs</span>
    <span class="badge">Zero-dep core</span>
    <span class="badge">MIT</span>
  </div>
</div>
</div>

<!-- Problem -->
<div class="container">
<section>
  <h2>Why Current IAM Fails for Agents</h2>
  <div class="problem-grid">
    <div class="problem-card">
      <h4>Bearer Token Scope</h4>
      <p>OAuth tokens grant broad access. An AI agent with a user's token can do anything the user can. There's no way to express "only purchases under $50 for gift cards."</p>
    </div>
    <div class="problem-card">
      <h4>Policy Server Latency</h4>
      <p>OPA/Cedar require a round-trip to evaluate policy. At agent scale — thousands of micro-decisions per second — that latency is a bottleneck.</p>
    </div>
    <div class="problem-card">
      <h4>No Offline Verify</h4>
      <p>When the policy server is down, agents stop. SPL policies travel with the token and evaluate locally in microseconds. No network required.</p>
    </div>
  </div>
</section>
</div>

<!-- Architecture -->
<div class="container">
<section>
  <h2>Architecture</h2>
  <div class="arch">
    <div class="arch-box">
      <div class="label">Grantor</div>
      <div class="name">Signs token</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box">
      <div class="label">Agent</div>
      <div class="name">Carries token</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box">
      <div class="label">Service</div>
      <div class="name">Verifies locally</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-box" style="border-color: var(--green);">
      <div class="label">Result</div>
      <div class="name" style="color: var(--green);">ALLOW / DENY</div>
    </div>
  </div>
  <p style="color: var(--muted); text-align: center;">Token = signed SPL policy + Merkle root + proofs + DPoP binding. Verification is one function call.</p>
</section>
</div>

<!-- Interactive Demo -->
<div class="container">
<section>
  <h2>Try It</h2>
  <div class="demo">
    <div class="demo-row">
      <div>
        <label>Policy (SPL)</label>
        <textarea id="demo-policy">(and
  (= (get req "action") "payments.create")
  (<= (get req "amount") 50)
  (member (get req "recipient") allowed_recipients)
)</textarea>
      </div>
      <div>
        <label>Request (JSON)</label>
        <textarea id="demo-request">{
  "action": "payments.create",
  "amount": 30,
  "recipient": "niece@example.com"
}</textarea>
      </div>
    </div>
    <button onclick="runDemo()">Evaluate</button>
    <div id="demo-result"></div>
  </div>
</section>
</div>

<!-- Prior Art -->
<div class="container">
<section>
  <h2>Prior Art Comparison</h2>
  <table>
    <thead><tr><th>System</th><th>Policy Language</th><th>Portable Token</th><th>Total</th><th>Offline Verify</th><th>Deps</th></tr></thead>
    <tbody>
      <tr><td><strong>SPL</strong></td><td>S-expression</td><td>Yes</td><td>Yes</td><td>Yes</td><td>0</td></tr>
      <tr><td>Macaroons</td><td>Caveats (opaque)</td><td>Yes</td><td>N/A</td><td>Partial</td><td>HMAC lib</td></tr>
      <tr><td>Biscuit</td><td>Datalog</td><td>Yes</td><td>No</td><td>Yes</td><td>Protobuf</td></tr>
      <tr><td>Cedar</td><td>Custom DSL</td><td>No</td><td>Yes</td><td>No</td><td>Engine</td></tr>
      <tr><td>OPA/Rego</td><td>Rego</td><td>No</td><td>No</td><td>No</td><td>OPA server</td></tr>
      <tr><td>SPIFFE</td><td>N/A (identity)</td><td>SVID</td><td>N/A</td><td>Partial</td><td>SPIRE</td></tr>
    </tbody>
  </table>
</section>
</div>

<!-- Get Started -->
<div class="container">
<section>
  <h2>Get Started</h2>
  <div class="install-grid">
    <div class="install-card">
      <div class="lang">TypeScript / Node.js</div>
      <code>cd sdk/js && npm i && npm run build</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Go</div>
      <code>go get github.com/jmcentire/agent-safe/sdk/go</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Python</div>
      <code>pip install agent-safe-spl</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Rust</div>
      <code>cargo add agent-safe-spl</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">Java (Maven)</div>
      <code>cd sdk/java && mvn test</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
    <div class="install-card">
      <div class="lang">C# (.NET)</div>
      <code>cd sdk/csharp && dotnet test</code>
      <button class="copy-btn" onclick="copyCmd(this)">Copy</button>
    </div>
  </div>
</section>
</div>

<!-- Footer -->
<div class="container">
<footer>
  <a href="https://github.com/jmcentire/agent-safe">GitHub</a>
  <a href="https://github.com/jmcentire/agent-safe/blob/main/SPEC.md">SPEC</a>
  <a href="https://github.com/jmcentire/agent-safe/blob/main/HOWTO.md">HOWTO</a>
  <p style="margin-top: 12px;">MIT License &middot; Jeremy McEntire</p>
</footer>
</div>

<script>
// Minimal SPL evaluator (in-browser, no deps)
function tokenize(src) {
  const toks = []; let buf = '', inStr = false;
  for (let j = 0; j < src.length; j++) {
    const ch = src[j];
    if (inStr) { buf += ch; if (ch === '"' && src[j-1] !== '\\') { inStr = false; toks.push(buf); buf = ''; } continue; }
    if (ch === '"') { if (buf.trim()) toks.push(...buf.trim().split(/\s+/)); buf = '"'; inStr = true; continue; }
    if (ch === '(' || ch === ')') { if (buf.trim()) toks.push(...buf.trim().split(/\s+/)); toks.push(ch); buf = ''; continue; }
    buf += ch;
  }
  if (buf.trim()) toks.push(...buf.trim().split(/\s+/));
  return toks;
}
function parseSExpr(src) {
  const tokens = tokenize(src); let i = 0;
  function atom(t) { if (t==='#t') return true; if (t==='#f') return false; if (/^-?\d+(\.\d+)?$/.test(t)) return Number(t); if (t.startsWith('"')&&t.endsWith('"')) return JSON.parse(t); return t; }
  function parse() {
    if (i >= tokens.length) throw new Error('unexpected EOF');
    const t = tokens[i++];
    if (t === '(') { const a = []; while (tokens[i] !== ')') { if (i >= tokens.length) throw new Error('unterminated ('); a.push(parse()); } i++; return a; }
    if (t === ')') throw new Error('unexpected )');
    return atom(t);
  }
  return parse();
}
function evalS(n, ctx) {
  ctx._gas = (ctx._gas ?? 10000) - 1;
  if (ctx._gas < 0) throw new Error('gas budget exceeded');
  if (!Array.isArray(n)) {
    if (typeof n === 'string') {
      if (n === 'req') return ctx.req;
      if (ctx.vars && n in ctx.vars) return ctx.vars[n];
    }
    return n;
  }
  if (n.length === 0) return null;
  const [op, ...args] = n;
  switch (op) {
    case 'and': return args.every(a => !!evalS(a, ctx));
    case 'or': return args.some(a => !!evalS(a, ctx));
    case 'not': return !evalS(args[0], ctx);
    case '=': return evalS(args[0], ctx) === evalS(args[1], ctx);
    case '<=': return evalS(args[0], ctx) <= evalS(args[1], ctx);
    case '<': return evalS(args[0], ctx) < evalS(args[1], ctx);
    case '>=': return evalS(args[0], ctx) >= evalS(args[1], ctx);
    case '>': return evalS(args[0], ctx) > evalS(args[1], ctx);
    case 'member': case 'in': { const v = evalS(args[0], ctx), l = evalS(args[1], ctx); return Array.isArray(l) && l.includes(v); }
    case 'subset?': { const a = evalS(args[0], ctx), b = evalS(args[1], ctx); return Array.isArray(a) && Array.isArray(b) && a.every(x => b.includes(x)); }
    case 'before': return evalS(args[0], ctx) < evalS(args[1], ctx);
    case 'get': { const o = evalS(args[0], ctx), k = evalS(args[1], ctx); return o?.[k]; }
    case 'tuple': return args.map(a => evalS(a, ctx));
    case 'per-day-count': return 0;
    case 'dpop_ok?': case 'merkle_ok?': case 'vrf_ok?': case 'thresh_ok?': return true;
    default: throw new Error('Unknown op: ' + op);
  }
}

function runDemo() {
  const el = document.getElementById('demo-result');
  try {
    const policy = document.getElementById('demo-policy').value.trim();
    const request = JSON.parse(document.getElementById('demo-request').value);
    const ast = parseSExpr(policy);
    const ctx = {
      req: request,
      vars: { allowed_recipients: ['niece@example.com', 'mom@example.com'], now: new Date().toISOString() }
    };
    const result = !!evalS(ast, ctx);
    el.textContent = result ? 'ALLOW' : 'DENY';
    el.className = result ? 'allow' : 'deny';
  } catch (e) {
    el.textContent = 'Error: ' + e.message;
    el.className = 'error';
  }
}

function copyCmd(btn) {
  const code = btn.parentElement.querySelector('code').textContent;
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}
</script>
</body>
</html>
